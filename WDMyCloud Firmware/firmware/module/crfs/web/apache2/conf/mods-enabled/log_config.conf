
<IfModule log_config_module>

	<IfModule logio_module>

		# Do not log certain requests that might not be useful and that
		# are logged often
		# Modify this as needed
		SetEnvIf Request_URI (update_count|get_usb_info|internet_access|home_mgr|restAPI_action|google_analytics|get_share_name_list|hd_config|status_mgr|device_user|login_mgr|sysinfo) dontlog
		SetEnvIf Request_Method "OPTIONS" dontlog

		# Set the 'url' for analytics.  The regex filtering ensures only expected messages can get through, and that personal information does not pass through into the logs
		<If "%{REQUEST_URI} =~ m#^(\/api\/[0-9]+\.[0-9]+\/rest\/)([a-zA-Z_-]+)#" >
			# Rest API, print match of regex
			SetEnvIf REQUEST_URI "^(\/api\/[0-9]+\.[0-9]+\/rest\/)([a-zA-Z_-]+)" url=$1$2$3
		</If>
		<ElseIf "%{REQUEST_URI} =~ m#^(\/sdk\/[0-9v.]+\/)([a-zA-Z_-]+)(?:\/?)(?:([^\/]+)?)(?:\/?)(?:([a-z]+)?)#" >
			# SDK request, do not include optional file path (3rd level path)
 			SetEnvIf REQUEST_URI "^(\/sdk\/[0-9v.]+\/)([a-zA-Z_-]+)(?:\/?)(?:([^\/]+)?)(?:\/?)(?:([a-z]+)?)" url=$1$2/$4
		</ElseIf>
		<ElseIf "%{REQUEST_URI} =~ m#^(\/UI\/|\/web\/|\/cgi-bin\/|\/xml\/)#" >
			# UI scripts, just log the request as UI, don't look at the rest of the URL
 			SetEnvIf REQUEST_URI ^(\/UI\/|\/web\/|\/cgi-bin\/|\/xml\/) url=$1
		</ElseIf>
        <ElseIf "%{REQUEST_URI} =~ /^$/ >
            # Add case for "empty" request
            SetEnv url "-"
        </ElseIf>
        <Else>
            # Anything else that is not recognized, log as unrecognized
            SetEnv url "UNRECOGNIZED URI PATTERN"
        </Else>

		# Set the 'Src' print the first 26 chars from the user-agent
		SetEnvIf User-Agent "(.{1,26})" Src=$1

        
		# Logs in the wdlog format, required for analytics to third-party
		LogFormat "%{%Y-%m-%dT%H:%M:%S}t%{%z}t di=${MYCL_ID} { mi:\"web\", rm:\"%m\", rurl:\"%{url}e\", rp:\"%P\", rsrc:\"%{Src}e\", t:%D, s:%>s, I:%I, O:%O }" wdlogfmt 
 	    CustomLog "|/usr/bin/rotatelogs -p /usr/local/sbin/rotateApache.sh -n 2 /var/log/apache2/${ACCESS_LOG_FILE} 200K" wdlogfmt env=!dontlog
       
	</IfModule>

</IfModule>

